name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for same ref
concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test
  NEXTAUTH_URL: http://localhost:3000
  NEXTAUTH_SECRET: test-secret-ci-only-1234567890abcdef
  GOOGLE_CLIENT_ID: test_google_client_id
  GOOGLE_CLIENT_SECRET: test_google_client_secret
  ENCRYPTION_KEY: '0000000000000000000000000000000000000000000000000000000000000000'
  OPENAI_API_KEY: test_openai_key
  RESEND_API_KEY: test_resend_key
  ADMIN_EMAILS: admin@example.com

jobs:
  # ============================================================================
  # Safety Checks
  # ============================================================================
  safety-checks:
    name: Safety Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      - name: Verify test environment
        run: |
          echo "NODE_ENV=$NODE_ENV"
          if [ "$NODE_ENV" != "test" ]; then
            echo "ERROR: NODE_ENV must be 'test'"
            exit 1
          fi
          echo "âœ“ Environment is safe for testing"

  # ============================================================================
  # Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: safety-checks
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate

      - name: Run Unit Tests
        run: npx vitest run --reporter=verbose
        env:
          TEST_TYPE: unit
          TEST_NEEDS_DB: 'false'
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          DIRECT_URL: 'postgresql://test:test@localhost:5432/test'

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage/

  # ============================================================================
  # Integration Tests (with Neon Branch)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: ${{ vars.NEON_PROJECT_ID != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate

      - name: Create Neon Test Branch
        id: create-branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          NEON_STAGING_BRANCH_ID: ${{ vars.NEON_STAGING_BRANCH_ID }}
        run: |
          BRANCH_NAME="ci-integration-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Creating Neon branch: $BRANCH_NAME"
          npx tsx -e "
            const { createTestBranch, waitForBranchReady, getBranchConnectionStrings } = require('./tests/setup/neon-branch');
            (async () => {
              const branch = await createTestBranch('$BRANCH_NAME');
              await waitForBranchReady(branch.id);
              const conn = await getBranchConnectionStrings(branch.id);
              console.log('BRANCH_ID=' + branch.id);
              console.log('DATABASE_URL=' + conn.databaseUrl);
              console.log('DIRECT_URL=' + conn.directUrl);
            })();
          " > branch-info.txt
          cat branch-info.txt
          echo "branch_id=$(grep BRANCH_ID branch-info.txt | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Run Integration Tests
        env:
          TEST_TYPE: integration
          TEST_NEEDS_DB: 'true'
          NEON_BRANCH_ID: ${{ steps.create-branch.outputs.branch_id }}
        run: npx vitest run --reporter=verbose tests/integration/

      - name: Always Cleanup Neon Branch
        if: always()
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
        run: |
          BRANCH_ID="${{ steps.create-branch.outputs.branch_id }}"
          if [ -n "$BRANCH_ID" ]; then
            echo "Cleaning up branch: $BRANCH_ID"
            npx tsx scripts/cleanup-branch.ts "$BRANCH_ID"
          fi

  # ============================================================================
  # E2E Tests (with Neon Branch)
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: ${{ vars.NEON_PROJECT_ID != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      - run: npx playwright install --with-deps chromium

      - name: Create Neon E2E Branch
        id: create-e2e-branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
          NEON_STAGING_BRANCH_ID: ${{ vars.NEON_STAGING_BRANCH_ID }}
        run: |
          BRANCH_NAME="ci-e2e-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Creating Neon E2E branch: $BRANCH_NAME"
          npx tsx -e "
            const { createTestBranch, waitForBranchReady, getBranchConnectionStrings } = require('./tests/setup/neon-branch');
            (async () => {
              const branch = await createTestBranch('$BRANCH_NAME');
              await waitForBranchReady(branch.id);
              const conn = await getBranchConnectionStrings(branch.id);
              console.log('BRANCH_ID=' + branch.id);
              console.log('DATABASE_URL=' + conn.databaseUrl);
              console.log('DIRECT_URL=' + conn.directUrl);
            })();
          " > e2e-branch-info.txt
          cat e2e-branch-info.txt
          echo "branch_id=$(grep BRANCH_ID e2e-branch-info.txt | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Run E2E Tests
        env:
          TEST_TYPE: e2e
          NEON_BRANCH_ID: ${{ steps.create-e2e-branch.outputs.branch_id }}
        run: npx playwright test

      - name: Upload E2E Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/

      - name: Always Cleanup E2E Branch
        if: always()
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
        run: |
          BRANCH_ID="${{ steps.create-e2e-branch.outputs.branch_id }}"
          if [ -n "$BRANCH_ID" ]; then
            echo "Cleaning up E2E branch: $BRANCH_ID"
            npx tsx scripts/cleanup-branch.ts "$BRANCH_ID"
          fi

  # ============================================================================
  # Security Audit
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: safety-checks
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: npm audit
        run: npm audit --audit-level=high || true

